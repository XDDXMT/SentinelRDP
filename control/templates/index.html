<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SentinelRDP æ§åˆ¶å°</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    header {
      background: linear-gradient(90deg, #2c3e50, #3498db);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #2ecc71;
    }

    .status.offline .status-indicator {
      background: #e74c3c;
    }

    #login_box {
      padding: 40px;
      text-align: center;
    }

    #login_box h3 {
      margin-bottom: 20px;
      color: #2c3e50;
    }

    input {
      display: block;
      width: 300px;
      margin: 10px auto;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }

    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
      margin: 5px;
    }

    button:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    button.danger {
      background: #e74c3c;
    }

    button.danger:hover {
      background: #c0392b;
    }

    button.auto-approve {
      background: #27ae60;
    }

    button.auto-approve:hover {
      background: #219653;
    }

    button.small {
      padding: 6px 12px;
      font-size: 12px;
    }

    #login_msg {
      margin-top: 15px;
      color: #e74c3c;
      font-weight: 500;
    }

    #main {
      display: none;
      padding: 20px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      flex: 1;
      min-width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      padding: 20px;
      border-top: 4px solid #3498db;
    }

    .card h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .table-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .table-row.approved {
      background-color: #f0fff4;
      border-left: 4px solid #27ae60;
      padding-left: 10px;
    }

    .client-ip {
      font-weight: 600;
      font-family: monospace;
    }

    .client-ip.approved-ip {
      color: #27ae60;
    }

    .auto-approve-badge {
      background: #27ae60;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: inline-block;
      margin-top: 5px;
    }

    .ip-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .ip-address {
      font-family: monospace;
      font-weight: 600;
    }

    .ip-expire {
      color: #7f8c8d;
      font-size: 12px;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .reconnect-guide {
      background: white;
      padding: 25px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .reconnect-guide h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .steps {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }

    .steps ol {
      margin: 10px 0 0 20px;
    }

    .steps li {
      margin: 8px 0;
    }

    .auto-note {
      color: #27ae60;
      font-weight: 600;
      margin: 10px 0;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .section-title .icon {
      font-size: 24px;
    }

    .stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      flex: 1;
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #3498db;
    }

    .stat-label {
      font-size: 14px;
      color: #7f8c8d;
    }

    .footer {
      text-align: center;
      padding: 15px;
      color: #7f8c8d;
      font-size: 14px;
      border-top: 1px solid #eee;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>SentinelRDP æ§åˆ¶å°</h1>
      <div class="status" id="connection_status">
        <div class="status-indicator"></div>
        <span>è¿æ¥ä¸­...</span>
      </div>
    </header>

    <div id="login_box">
      <h3>ç®¡ç†å‘˜ç™»å½•</h3>
      <input id="username" placeholder="ç”¨æˆ·å" value="admin">
      <input id="password" placeholder="å¯†ç " type="password">
      <button onclick="login()">ç™»å½•</button>
      <div id="login_msg"></div>
    </div>

    <div id="main" style="display:none;">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="agents_count">0</div>
          <div class="stat-label">åœ¨çº¿åˆ†æœ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pending_count">0</div>
          <div class="stat-label">å¾…å¤„ç†è¯·æ±‚</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="sessions_count">0</div>
          <div class="stat-label">æ´»è·ƒä¼šè¯</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="approved_ips_count">0</div>
          <div class="stat-label">å·²æ‰¹å‡†IP</div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <span class="icon">âœ…</span>
          <h3>å·²æ‰¹å‡†çš„IPåœ°å€ï¼ˆ24å°æ—¶æœ‰æ•ˆï¼‰</h3>
        </div>
        <div id="approved_ips"></div>
      </div>

      <div class="row">
        <div class="card">
          <div class="section-title">
            <span class="icon">ğŸ–¥ï¸</span>
            <h3>åœ¨çº¿åˆ†æœ</h3>
          </div>
          <div id="agents"></div>
        </div>

        <div class="card">
          <div class="section-title">
            <span class="icon">â³</span>
            <h3>å¾…æˆæƒè¯·æ±‚</h3>
          </div>
          <div id="pending"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <span class="icon">ğŸ‘¥</span>
          <h3>ä¼šè¯ç®¡ç†ï¼ˆæ‰€æœ‰åˆ†æœï¼‰</h3>
        </div>
        <div id="sessions"></div>
      </div>

      <div class="footer">
        SentinelRDP æ§åˆ¶å° v2.0 | å¢å¼ºç‰ˆIPç™½åå•ç®¡ç†
        main 9833
        mty 1033
        sscc 9844
      </div>
    </div>
  </div>

  <div id="reconnectGuide" class="modal-overlay">
    <!-- å†…å®¹ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
  </div>

  <script>
    // control/static/ws.js
    let socket = io(); // connects to /socket.io
    let token = null;
    let approvedIPs = new Map(); // å­˜å‚¨å·²æ‰¹å‡†çš„IPå’Œè¿‡æœŸæ—¶é—´

    function login(){
      let u = document.getElementById("username").value;
      let p = document.getElementById("password").value;
      fetch("/api/login", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({username:u,password:p})})
        .then(r=>r.json()).then(j=>{
          if (j.token){
            token = j.token;
            document.getElementById("login_box").style.display = "none";
            document.getElementById("main").style.display = "block";
            // register web client
            socket.emit("web_register", {});
            // åŠ è½½å·²æ‰¹å‡†çš„IPåˆ—è¡¨
            loadApprovedIPs();
            // æ›´æ–°è¿æ¥çŠ¶æ€
            updateConnectionStatus(true);
          } else {
            document.getElementById("login_msg").innerText = JSON.stringify(j);
          }
        });
    }

    // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
    function updateConnectionStatus(connected) {
      const statusEl = document.getElementById('connection_status');
      if (connected) {
        statusEl.classList.remove('offline');
        statusEl.querySelector('span').textContent = 'å·²è¿æ¥';
      } else {
        statusEl.classList.add('offline');
        statusEl.querySelector('span').textContent = 'è¿æ¥æ–­å¼€';
      }
    }

    // åŠ è½½å·²æ‰¹å‡†çš„IPåˆ—è¡¨
    function loadApprovedIPs() {
      // è¿™é‡Œå¯ä»¥æ·»åŠ APIè°ƒç”¨è·å–å·²æ‰¹å‡†IPåˆ—è¡¨
      // æš‚æ—¶ä»localStorageåŠ è½½
      const saved = localStorage.getItem('approved_ips');
      if (saved) {
        approvedIPs = new Map(JSON.parse(saved));
        updateApprovedIPsDisplay();
      }
    }

    // ä¿å­˜å·²æ‰¹å‡†çš„IPåˆ—è¡¨
    function saveApprovedIPs() {
      localStorage.setItem('approved_ips', JSON.stringify(Array.from(approvedIPs.entries())));
    }

    // æ›´æ–°å·²æ‰¹å‡†IPæ˜¾ç¤º
    function updateApprovedIPsDisplay() {
      const el = document.getElementById("approved_ips");
      if (!el) return;

      el.innerHTML = '';
      let count = 0;
      approvedIPs.forEach((expireTime, ip) => {
        const remaining = Math.max(0, expireTime - Date.now());
        if (remaining > 0) {
          count++;
          const hours = Math.floor(remaining / (1000 * 60 * 60));
          const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));

          const ipEl = document.createElement("div");
          ipEl.className = "ip-item";
          ipEl.innerHTML = `
            <div>
              <span class="ip-address">${ip}</span>
              <span class="ip-expire">å‰©ä½™: ${hours}å°æ—¶${minutes}åˆ†é’Ÿ</span>
            </div>
            <button onclick="removeApprovedIP('${ip}')" class="danger small">ç§»é™¤</button>
          `;
          el.appendChild(ipEl);
        } else {
          // ç§»é™¤è¿‡æœŸIP
          approvedIPs.delete(ip);
        }
      });

      // æ›´æ–°ç»Ÿè®¡
      document.getElementById('approved_ips_count').textContent = count;
      saveApprovedIPs();

      if (count === 0) {
        el.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— å·²æ‰¹å‡†çš„IPåœ°å€</div>';
      }
    }

    // ç§»é™¤å·²æ‰¹å‡†çš„IP
    function removeApprovedIP(ip) {
      approvedIPs.delete(ip);
      saveApprovedIPs();
      updateApprovedIPsDisplay();
    }

    socket.on("connect", () => {
      updateConnectionStatus(true);
    });

    socket.on("disconnect", () => {
      updateConnectionStatus(false);
    });

    socket.on("system", (msg) => {
      if (!msg || !msg.type) return;
      if (msg.type === "agents") renderAgents(msg.list);
      if (msg.type === "pending") renderPending(msg.list);
      if (msg.type === "sessions") renderSessions(msg.list);
      if (msg.type === "whitelist") {
        // å¦‚æœæœ‰æœåŠ¡å™¨ç«¯çš„ç™½åå•æ•°æ®ï¼Œå¯ä»¥åŒæ­¥
        console.log("Whitelist update:", msg);
      }
      if (msg.type === "auto_approve") {
        console.log("Auto-approved session:", msg.log);
      }
    });

    // render helpers
    function renderAgents(list){
      let el = document.getElementById("agents");
      el.innerHTML = "";
      let count = 0;

      for (const aid in list){
        count++;
        const item = list[aid];
        let d = document.createElement("div");
        d.className="table-row";
        d.innerHTML = `
          <div>
            <strong>${aid}</strong><br>
            <small>ä¸»æœº: ${item.info.host || 'æœªçŸ¥'}</small>
          </div>
          <div style="color: #27ae60;">åœ¨çº¿</div>
        `;
        el.appendChild(d);
      }

      document.getElementById('agents_count').textContent = count;

      if (count === 0) {
        el.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— åœ¨çº¿åˆ†æœ</div>';
      }
    }

    function renderPending(list){
      let el = document.getElementById("pending");
      el.innerHTML = "";
      let count = 0;

      list.forEach(req=>{
        count++;
        const isApproved = approvedIPs.has(req.client_ip) && approvedIPs.get(req.client_ip) > Date.now();

        let d = document.createElement("div");
        d.className = `table-row ${isApproved ? 'approved' : ''}`;

        d.innerHTML = `
          <div>
            <strong>${req.agent_id}</strong> â†’
            <span class="client-ip ${isApproved ? 'approved-ip' : ''}">${req.client_ip}</span>
            <br>
            <small>æ—¶é—´: ${new Date(req.ts*1000).toLocaleString()}</small>
            ${isApproved ? '<br><span class="auto-approve-badge">è‡ªåŠ¨æ‰¹å‡†</span>' : ''}
          </div>
          <div>
            <button onclick='allow("${req.agent_id}","${req.session_id}","${req.client_ip}")'>é€šè¿‡</button>
            <button onclick='allowAndAuto("${req.agent_id}","${req.session_id}","${req.client_ip}")' class="auto-approve">è‡ªåŠ¨æ‰¹å‡†IP</button>
            <button class="danger" onclick='deny("${req.agent_id}","${req.session_id}")'>æ‹’ç»</button>
          </div>
        `;
        el.appendChild(d);
      });

      document.getElementById('pending_count').textContent = count;

      if (count === 0) {
        el.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— å¾…å¤„ç†è¯·æ±‚</div>';
      }
    }

    function allow(agent, session_id, client_ip){
      fetch("/api/allow", {
        method:"POST",
        headers: {"Content-Type":"application/json", "X-Auth-Token": token},
        body: JSON.stringify({agent_id: agent, session_id: session_id, expire: 86400})
      }).then(response => response.json()).then(data => {
        if (data.ok) {
          showReconnectGuide(client_ip, false);
        }
      });
    }

    // è‡ªåŠ¨æ‰¹å‡†è¯¥IPçš„æ‰€æœ‰è¿æ¥ï¼ˆ24å°æ—¶ï¼‰
    function allowAndAuto(agent, session_id, client_ip){
      const expireHours = 24;
      const expireTime = Date.now() + (expireHours * 60 * 60 * 1000);

      // æ·»åŠ åˆ°è‡ªåŠ¨æ‰¹å‡†åˆ—è¡¨
      approvedIPs.set(client_ip, expireTime);
      saveApprovedIPs();
      updateApprovedIPsDisplay();

      // æ‰¹å‡†å½“å‰ä¼šè¯
      fetch("/api/allow", {
        method:"POST",
        headers: {"Content-Type":"application/json", "X-Auth-Token": token},
        body: JSON.stringify({agent_id: agent, session_id: session_id, expire: 86400, client_ip: client_ip})
      }).then(response => response.json()).then(data => {
        if (data.ok) {
          showReconnectGuide(client_ip, true);

          // è‡ªåŠ¨æ‰¹å‡†è¯¥IPçš„å…¶ä»–å¾…å¤„ç†ä¼šè¯
          autoApproveOtherSessions(client_ip);
        }
      });
    }

    // è‡ªåŠ¨æ‰¹å‡†åŒä¸€IPçš„å…¶ä»–ä¼šè¯
    function autoApproveOtherSessions(client_ip) {
      // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥é€šè¿‡APIè‡ªåŠ¨æ‰¹å‡†åŒä¸€IPçš„æ‰€æœ‰ä¼šè¯
      console.log(`è‡ªåŠ¨æ‰¹å‡†IP ${client_ip} çš„å…¶ä»–ä¼šè¯`);
    }

    function deny(agent, session_id){
      fetch("/api/kick", {
        method:"POST",
        headers: {"Content-Type":"application/json", "X-Auth-Token": token},
        body: JSON.stringify({agent_id: agent, session_id: session_id})
      });
    }

    function renderSessions(list){
      let el = document.getElementById("sessions");
      el.innerHTML = "";
      let totalSessions = 0;

      for (const agent in list){
        const group = list[agent];
        let head = document.createElement("div");
        head.className="card";
        head.style.marginBottom = "15px";
        head.style.borderTop = "3px solid #3498db";

        head.innerHTML = `<h4>${agent}</h4>`;
        let sessionCount = 0;

        for (const sid in group){
          sessionCount++;
          totalSessions++;
          const s = group[sid];
          let r = document.createElement("div");
          r.className="table-row";
          r.innerHTML = `
            <div>
              <b>${s.client_ip}</b><br>
              <small>å¼€å§‹æ—¶é—´: ${new Date(s.start_time*1000).toLocaleString()}</small>
            </div>
            <div><button onclick='kick("${agent}","${sid}")' class="danger">è¸¢ä¸‹çº¿</button></div>`;
          head.appendChild(r);
        }

        if (sessionCount > 0) {
          el.appendChild(head);
        }
      }

      document.getElementById('sessions_count').textContent = totalSessions;

      if (totalSessions === 0) {
        el.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— æ´»è·ƒä¼šè¯</div>';
      }
    }

    function kick(agent, session_id){
      fetch("/api/kick", {
        method:"POST",
        headers: {"Content-Type":"application/json", "X-Auth-Token": token},
        body: JSON.stringify({agent_id: agent, session_id: session_id})
      });
    }

    // æ˜¾ç¤ºé‡è¿æŒ‡å¯¼
    function showReconnectGuide(client_ip, isAutoApprove) {
      const guideHtml = `
        <div class="reconnect-guide">
          <h3>è¿æ¥å·²æ‰¹å‡†</h3>
          <p>IPåœ°å€: <strong>${client_ip}</strong></p>
          ${isAutoApprove ? '<p class="auto-note">âœ… è¯¥IPå·²åŠ å…¥è‡ªåŠ¨æ‰¹å‡†åˆ—è¡¨ï¼ˆ24å°æ—¶æœ‰æ•ˆï¼‰</p>' : ''}
          <div class="steps">
            <p><strong>è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</strong></p>
            <ol>
              <li>è®©ç”¨æˆ·æ–­å¼€å½“å‰çš„RDPè¿æ¥</li>
              <li>ç­‰å¾…5-10ç§’</li>
              <li>è®©ç”¨æˆ·é‡æ–°è¿›è¡ŒRDPè¿æ¥</li>
              <li>æœ¬æ¬¡è¿æ¥å°†è‡ªåŠ¨æˆåŠŸ</li>
            </ol>
          </div>
          <button onclick="closeReconnectGuide()" class="primary">ç¡®å®š</button>
        </div>
      `;

      let guideEl = document.getElementById('reconnectGuide');
      if (!guideEl) {
        guideEl = document.createElement('div');
        guideEl.id = 'reconnectGuide';
        guideEl.className = 'modal-overlay';
        document.body.appendChild(guideEl);
      }

      guideEl.innerHTML = guideHtml;
      guideEl.style.display = 'flex';
    }

    function closeReconnectGuide() {
      const guideEl = document.getElementById('reconnectGuide');
      if (guideEl) {
        guideEl.style.display = 'none';
      }
    }

    // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeReconnectGuide();
      }
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // æ¨¡æ‹Ÿä¸€äº›åˆå§‹æ•°æ®ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­è¿™äº›æ•°æ®ä¼šä»æœåŠ¡å™¨è·å–ï¼‰
      setTimeout(() => {
        if (document.getElementById('main').style.display === 'block') {
          // æ¨¡æ‹Ÿä¸€äº›å·²æ‰¹å‡†çš„IP
          approvedIPs.set('192.168.1.100', Date.now() + 12 * 60 * 60 * 1000); // 12å°æ—¶åè¿‡æœŸ
          approvedIPs.set('10.0.0.55', Date.now() + 6 * 60 * 60 * 1000); // 6å°æ—¶åè¿‡æœŸ
          updateApprovedIPsDisplay();
        }
      }, 1000);
    });
  </script>
</body>
</html>